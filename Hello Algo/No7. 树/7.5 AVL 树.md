åœ¨â€œäºŒå‰æœç´¢æ ‘â€ç« èŠ‚ä¸­æˆ‘ä»¬æåˆ°ï¼Œåœ¨å¤šæ¬¡æ’å…¥å’Œåˆ é™¤æ“ä½œåï¼ŒäºŒå‰æœç´¢æ ‘å¯èƒ½é€€åŒ–ä¸ºé“¾è¡¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å°†ä»Â ğ‘‚(logâ¡ğ‘›)Â åŠ£åŒ–ä¸ºÂ ğ‘‚(ğ‘›)Â ã€‚

åœ¨éœ€è¦é¢‘ç¹è¿›è¡Œå¢åˆ æŸ¥æ”¹æ“ä½œçš„åœºæ™¯ä¸­ï¼ŒAVL æ ‘èƒ½å§‹ç»ˆä¿æŒé«˜æ•ˆçš„æ•°æ®æ“ä½œæ€§èƒ½ï¼Œå…·æœ‰å¾ˆå¥½çš„åº”ç”¨ä»·å€¼ã€‚

## 7.5.1 AVL æ ‘å¸¸è§æœ¯è¯­
AVL æ ‘æ—¢æ˜¯äºŒå‰æœç´¢æ ‘ï¼Œä¹Ÿæ˜¯å¹³è¡¡äºŒå‰æ ‘ï¼ŒåŒæ—¶æ»¡è¶³è¿™ä¸¤ç±»äºŒå‰æ ‘çš„æ‰€æœ‰æ€§è´¨ï¼Œå› æ­¤æ˜¯ä¸€ç§å¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼ˆbalanced binary search treeï¼‰ã€‚

### 1. èŠ‚ç‚¹é«˜åº¦
ç”±äº AVL æ ‘çš„ç›¸å…³æ“ä½œéœ€è¦è·å–èŠ‚ç‚¹é«˜åº¦ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸ºèŠ‚ç‚¹ç±»æ·»åŠ Â `height`Â å˜é‡ï¼š
```python
class TreeNode:
	"""AVL æ ‘èŠ‚ç‚¹ç±»"""
	def __init__(self, val: int):
	    self.val: int = val                 # èŠ‚ç‚¹å€¼
	    self.height: int = 0                # èŠ‚ç‚¹é«˜åº¦
	    self.left: TreeNode | None = None   # å·¦å­èŠ‚ç‚¹å¼•ç”¨
	    self.right: TreeNode | None = None  # å³å­èŠ‚ç‚¹å¼•ç”¨
```
â€œèŠ‚ç‚¹é«˜åº¦â€æ˜¯æŒ‡ä»è¯¥èŠ‚ç‚¹åˆ°å®ƒçš„æœ€è¿œå¶èŠ‚ç‚¹çš„è·ç¦»ï¼Œå³æ‰€ç»è¿‡çš„â€œè¾¹â€çš„æ•°é‡ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œå¶èŠ‚ç‚¹çš„é«˜åº¦ä¸ºÂ 0Â ï¼Œè€Œç©ºèŠ‚ç‚¹çš„é«˜åº¦ä¸ºÂ âˆ’1Â ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸¤ä¸ªå·¥å…·å‡½æ•°ï¼Œåˆ†åˆ«ç”¨äºè·å–å’Œæ›´æ–°èŠ‚ç‚¹çš„é«˜åº¦ï¼š
```python
def height(self, node: TreeNode | None) -> int:
    """è·å–èŠ‚ç‚¹é«˜åº¦"""
    # ç©ºèŠ‚ç‚¹é«˜åº¦ä¸º -1 ï¼Œå¶èŠ‚ç‚¹é«˜åº¦ä¸º 0
    if node is not None:
        return node.height
    return -1

def update_height(self, node: TreeNode | None):
    """æ›´æ–°èŠ‚ç‚¹é«˜åº¦"""
    # èŠ‚ç‚¹é«˜åº¦ç­‰äºæœ€é«˜å­æ ‘é«˜åº¦ + 1
    node.height = max([self.height(node.left), self.height(node.right)]) + 1
```
### 2. èŠ‚ç‚¹å¹³è¡¡å› å­
èŠ‚ç‚¹çš„å¹³è¡¡å› å­ï¼ˆbalance factorï¼‰å®šä¹‰ä¸ºèŠ‚ç‚¹å·¦å­æ ‘çš„é«˜åº¦å‡å»å³å­æ ‘çš„é«˜åº¦ï¼ŒåŒæ—¶è§„å®šç©ºèŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¸ºÂ 0Â ã€‚æˆ‘ä»¬åŒæ ·å°†è·å–èŠ‚ç‚¹å¹³è¡¡å› å­çš„åŠŸèƒ½å°è£…æˆå‡½æ•°ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ï¼š
```python
def balance_factor(self, node: TreeNode | None) -> int:
	"""è·å–å¹³è¡¡å› å­"""
	# ç©ºèŠ‚ç‚¹å¹³è¡¡å› å­ä¸º 0
	if node is None:
	    return 0
	# èŠ‚ç‚¹å¹³è¡¡å› å­ = å·¦å­æ ‘é«˜åº¦ - å³å­æ ‘é«˜åº¦
	return self.height(node.left) - self.height(node.right)
```

## 7.5.2 AVL æ ‘æ—‹è½¬
AVL æ ‘çš„ç‰¹ç‚¹åœ¨äºâ€œæ—‹è½¬â€æ“ä½œï¼Œå®ƒèƒ½å¤Ÿåœ¨ä¸å½±å“äºŒå‰æ ‘çš„ä¸­åºéå†åºåˆ—çš„å‰æä¸‹ï¼Œä½¿å¤±è¡¡èŠ‚ç‚¹é‡æ–°æ¢å¤å¹³è¡¡ã€‚æ¢å¥è¯è¯´ï¼Œ**æ—‹è½¬æ“ä½œæ—¢èƒ½ä¿æŒâ€œäºŒå‰æœç´¢æ ‘â€çš„æ€§è´¨ï¼Œä¹Ÿèƒ½ä½¿æ ‘é‡æ–°å˜ä¸ºâ€œå¹³è¡¡äºŒå‰æ ‘â€**ã€‚
æˆ‘ä»¬å°†å¹³è¡¡å› å­ç»å¯¹å€¼Â >1Â çš„èŠ‚ç‚¹ç§°ä¸ºâ€œå¤±è¡¡èŠ‚ç‚¹â€ã€‚æ ¹æ®èŠ‚ç‚¹å¤±è¡¡æƒ…å†µçš„ä¸åŒï¼Œæ—‹è½¬æ“ä½œåˆ†ä¸ºå››ç§ï¼šå³æ—‹ã€å·¦æ—‹ã€å…ˆå³æ—‹åå·¦æ—‹ã€å…ˆå·¦æ—‹åå³æ—‹ã€‚ä¸‹é¢è¯¦ç»†ä»‹ç»è¿™äº›æ—‹è½¬æ“ä½œã€‚
### 1. å³æ—‹
ä¸‹å›¾æ‰€ç¤ºï¼ŒèŠ‚ç‚¹ä¸‹æ–¹ä¸ºå¹³è¡¡å› å­ã€‚ä»åº•è‡³é¡¶çœ‹ï¼ŒäºŒå‰æ ‘ä¸­é¦–ä¸ªå¤±è¡¡èŠ‚ç‚¹æ˜¯â€œèŠ‚ç‚¹ 3â€ã€‚æˆ‘ä»¬å…³æ³¨ä»¥è¯¥å¤±è¡¡èŠ‚ç‚¹ä¸ºæ ¹èŠ‚ç‚¹çš„å­æ ‘ï¼Œå°†è¯¥èŠ‚ç‚¹è®°ä¸ºÂ `node`Â ï¼Œå…¶å·¦å­èŠ‚ç‚¹è®°ä¸ºÂ `child`Â ï¼Œæ‰§è¡Œâ€œå³æ—‹â€æ“ä½œã€‚å®Œæˆå³æ—‹åï¼Œå­æ ‘æ¢å¤å¹³è¡¡ï¼Œå¹¶ä¸”ä»ç„¶ä¿æŒäºŒå‰æœç´¢æ ‘çš„æ€§è´¨ã€‚
![[Pasted image 20240603215042.png]]
![[Pasted image 20240603215050.png]]
![[Pasted image 20240603215058.png]]
![[Pasted image 20240603215104.png]]

å½“èŠ‚ç‚¹Â `child`Â æœ‰å³å­èŠ‚ç‚¹ï¼ˆè®°ä¸ºÂ `grand_child`Â ï¼‰æ—¶ï¼Œéœ€è¦åœ¨å³æ—‹ä¸­æ·»åŠ ä¸€æ­¥ï¼šå°†Â `grand_child`Â ä½œä¸ºÂ `node`Â çš„å·¦å­èŠ‚ç‚¹ã€‚
![[Pasted image 20240603215118.png]]
â€œå‘å³æ—‹è½¬â€æ˜¯ä¸€ç§å½¢è±¡åŒ–çš„è¯´æ³•ï¼Œå®é™…ä¸Šéœ€è¦é€šè¿‡ä¿®æ”¹èŠ‚ç‚¹æŒ‡é’ˆæ¥å®ç°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
```python
def right_rotate(self, node: TreeNode | None) -> TreeNode | None:
	"""å³æ—‹æ“ä½œ"""
	child = node.left
	grand_child = child.right
	# ä»¥ child ä¸ºåŸç‚¹ï¼Œå°† node å‘å³æ—‹è½¬
	child.right = node
	node.left = grand_child
	# æ›´æ–°èŠ‚ç‚¹é«˜åº¦
	self.update_height(node)
	self.update_height(child)
	# è¿”å›æ—‹è½¬åå­æ ‘çš„æ ¹èŠ‚ç‚¹
	return child
```

### 2. å·¦æ—‹
ç›¸åº”åœ°ï¼Œå¦‚æœè€ƒè™‘ä¸Šè¿°å¤±è¡¡äºŒå‰æ ‘çš„â€œé•œåƒâ€ï¼Œåˆ™éœ€è¦æ‰§è¡Œä¸‹å›¾æ‰€ç¤ºçš„â€œå·¦æ—‹â€æ“ä½œã€‚
![[Pasted image 20240603215156.png]]
åŒç†ï¼Œå½“èŠ‚ç‚¹Â `child`Â æœ‰å·¦å­èŠ‚ç‚¹ï¼ˆè®°ä¸ºÂ `grand_child`Â ï¼‰æ—¶ï¼Œéœ€è¦åœ¨å·¦æ—‹ä¸­æ·»åŠ ä¸€æ­¥ï¼šå°†Â `grand_child`Â ä½œä¸ºÂ `node`Â çš„å³å­èŠ‚ç‚¹ã€‚
![[Pasted image 20240603215209.png]]
å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œ**å³æ—‹å’Œå·¦æ—‹æ“ä½œåœ¨é€»è¾‘ä¸Šæ˜¯é•œåƒå¯¹ç§°çš„ï¼Œå®ƒä»¬åˆ†åˆ«è§£å†³çš„ä¸¤ç§å¤±è¡¡æƒ…å†µä¹Ÿæ˜¯å¯¹ç§°çš„**ã€‚åŸºäºå¯¹ç§°æ€§ï¼Œæˆ‘ä»¬åªéœ€å°†å³æ—‹çš„å®ç°ä»£ç ä¸­çš„æ‰€æœ‰çš„Â `left`Â æ›¿æ¢ä¸ºÂ `right`Â ï¼Œå°†æ‰€æœ‰çš„Â `right`Â æ›¿æ¢ä¸ºÂ `left`Â ï¼Œå³å¯å¾—åˆ°å·¦æ—‹çš„å®ç°ä»£ç ï¼š
```python
def left_rotate(self, node: TreeNode | None) -> TreeNode | None:
	"""å·¦æ—‹æ“ä½œ"""
	child = node.right
	grand_child = child.left
	# ä»¥ child ä¸ºåŸç‚¹ï¼Œå°† node å‘å·¦æ—‹è½¬
	child.left = node
	node.right = grand_child
	# æ›´æ–°èŠ‚ç‚¹é«˜åº¦
	self.update_height(node)
	self.update_height(child)
	# è¿”å›æ—‹è½¬åå­æ ‘çš„æ ¹èŠ‚ç‚¹
	return child
```

### 3. å…ˆå·¦æ—‹åå³æ—‹
å¯¹äºä¸‹å›¾ä¸­çš„å¤±è¡¡èŠ‚ç‚¹ 3 ï¼Œä»…ä½¿ç”¨å·¦æ—‹æˆ–å³æ—‹éƒ½æ— æ³•ä½¿å­æ ‘æ¢å¤å¹³è¡¡ã€‚æ­¤æ—¶éœ€è¦å…ˆå¯¹Â `child`Â æ‰§è¡Œâ€œå·¦æ—‹â€ï¼Œå†å¯¹Â `node`Â æ‰§è¡Œâ€œå³æ—‹â€ã€‚
![[Pasted image 20240603215253.png]]

### 4.  å…ˆå³æ—‹åå·¦æ—‹
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯¹äºä¸Šè¿°å¤±è¡¡äºŒå‰æ ‘çš„é•œåƒæƒ…å†µï¼Œéœ€è¦å…ˆå¯¹Â `child`Â æ‰§è¡Œâ€œå³æ—‹â€ï¼Œå†å¯¹Â `node`Â æ‰§è¡Œâ€œå·¦æ—‹â€ã€‚
![[Pasted image 20240603215317.png]]

### 5. æ—‹è½¬çš„é€‰æ‹©
ä¸‹å›¾å±•ç¤ºäº†å››ç§å¤±è¡¡æƒ…å†µä¸ä¸Šè¿°æ¡ˆä¾‹é€ä¸ªå¯¹åº”ï¼Œåˆ†åˆ«éœ€è¦é‡‡ç”¨å³æ—‹ã€å…ˆå·¦æ—‹åå³æ—‹ã€å…ˆå³æ—‹åå·¦æ—‹ã€å·¦æ—‹çš„æ“ä½œã€‚
![[Pasted image 20240603215347.png]]
å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œæˆ‘ä»¬é€šè¿‡åˆ¤æ–­å¤±è¡¡èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä»¥åŠè¾ƒé«˜ä¸€ä¾§å­èŠ‚ç‚¹çš„å¹³è¡¡å› å­çš„æ­£è´Ÿå·ï¼Œæ¥ç¡®å®šå¤±è¡¡èŠ‚ç‚¹å±äºä¸Šå›¾ä¸­çš„å“ªç§æƒ…å†µã€‚

|å¤±è¡¡èŠ‚ç‚¹çš„å¹³è¡¡å› å­|å­èŠ‚ç‚¹çš„å¹³è¡¡å› å­|åº”é‡‡ç”¨çš„æ—‹è½¬æ–¹æ³•|
|---|---|---|
|>1Â ï¼ˆå·¦åæ ‘ï¼‰|â‰¥0|å³æ—‹|
|>1Â ï¼ˆå·¦åæ ‘ï¼‰|<0|å…ˆå·¦æ—‹åå³æ—‹|
|<âˆ’1Â ï¼ˆå³åæ ‘ï¼‰|â‰¤0|å·¦æ—‹|
|<âˆ’1Â ï¼ˆå³åæ ‘ï¼‰|>0|å…ˆå³æ—‹åå·¦æ—‹|

ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œæˆ‘ä»¬å°†æ—‹è½¬æ“ä½œå°è£…æˆä¸€ä¸ªå‡½æ•°ã€‚**æœ‰äº†è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±èƒ½å¯¹å„ç§å¤±è¡¡æƒ…å†µè¿›è¡Œæ—‹è½¬ï¼Œä½¿å¤±è¡¡èŠ‚ç‚¹é‡æ–°æ¢å¤å¹³è¡¡**ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
```python
def rotate(self, node: TreeNode | None) -> TreeNode | None:
	"""æ‰§è¡Œæ—‹è½¬æ“ä½œï¼Œä½¿è¯¥å­æ ‘é‡æ–°æ¢å¤å¹³è¡¡"""
	# è·å–èŠ‚ç‚¹ node çš„å¹³è¡¡å› å­
	balance_factor = self.balance_factor(node)
	# å·¦åæ ‘
	if balance_factor > 1:
	    if self.balance_factor(node.left) >= 0:
	        # å³æ—‹
	        return self.right_rotate(node)
	    else:
	        # å…ˆå·¦æ—‹åå³æ—‹
	        node.left = self.left_rotate(node.left)
	        return self.right_rotate(node)
	# å³åæ ‘
	elif balance_factor < -1:
	    if self.balance_factor(node.right) <= 0:
	        # å·¦æ—‹
	        return self.left_rotate(node)
	    else:
	        # å…ˆå³æ—‹åå·¦æ—‹
	        node.right = self.right_rotate(node.right)
	        return self.left_rotate(node)
	# å¹³è¡¡æ ‘ï¼Œæ— é¡»æ—‹è½¬ï¼Œç›´æ¥è¿”å›
	return node
```

## 7.5.3 AVL æ ‘å¸¸ç”¨æ“ä½œ
### 1. æ’å…¥èŠ‚ç‚¹
AVL æ ‘çš„èŠ‚ç‚¹æ’å…¥æ“ä½œä¸äºŒå‰æœç´¢æ ‘åœ¨ä¸»ä½“ä¸Šç±»ä¼¼ã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼Œåœ¨ AVL æ ‘ä¸­æ’å…¥èŠ‚ç‚¹åï¼Œä»è¯¥èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„ä¸Šå¯èƒ½ä¼šå‡ºç°ä¸€ç³»åˆ—å¤±è¡¡èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œ**æˆ‘ä»¬éœ€è¦ä»è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹ï¼Œè‡ªåº•å‘ä¸Šæ‰§è¡Œæ—‹è½¬æ“ä½œï¼Œä½¿æ‰€æœ‰å¤±è¡¡èŠ‚ç‚¹æ¢å¤å¹³è¡¡**ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
```python
def insert(self, val):
    """æ’å…¥èŠ‚ç‚¹"""
    self._root = self.insert_helper(self._root, val)

def insert_helper(self, node: TreeNode | None, val: int) -> TreeNode:
    """é€’å½’æ’å…¥èŠ‚ç‚¹ï¼ˆè¾…åŠ©æ–¹æ³•ï¼‰"""
    if node is None:
        return TreeNode(val)
    # 1. æŸ¥æ‰¾æ’å…¥ä½ç½®å¹¶æ’å…¥èŠ‚ç‚¹
    if val < node.val:
        node.left = self.insert_helper(node.left, val)
    elif val > node.val:
        node.right = self.insert_helper(node.right, val)
    else:
        # é‡å¤èŠ‚ç‚¹ä¸æ’å…¥ï¼Œç›´æ¥è¿”å›
        return node
    # æ›´æ–°èŠ‚ç‚¹é«˜åº¦
    self.update_height(node)
    # 2. æ‰§è¡Œæ—‹è½¬æ“ä½œï¼Œä½¿è¯¥å­æ ‘é‡æ–°æ¢å¤å¹³è¡¡
    return self.rotate(node)
```

### 2. åˆ é™¤èŠ‚ç‚¹
ç±»ä¼¼åœ°ï¼Œåœ¨äºŒå‰æœç´¢æ ‘çš„åˆ é™¤èŠ‚ç‚¹æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œéœ€è¦ä»åº•è‡³é¡¶æ‰§è¡Œæ—‹è½¬æ“ä½œï¼Œä½¿æ‰€æœ‰å¤±è¡¡èŠ‚ç‚¹æ¢å¤å¹³è¡¡ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
```python
def remove(self, val: int):
    """åˆ é™¤èŠ‚ç‚¹"""
    self._root = self.remove_helper(self._root, val)

def remove_helper(self, node: TreeNode | None, val: int) -> TreeNode | None:
    """é€’å½’åˆ é™¤èŠ‚ç‚¹ï¼ˆè¾…åŠ©æ–¹æ³•ï¼‰"""
    if node is None:
        return None
    # 1. æŸ¥æ‰¾èŠ‚ç‚¹å¹¶åˆ é™¤
    if val < node.val:
        node.left = self.remove_helper(node.left, val)
    elif val > node.val:
        node.right = self.remove_helper(node.right, val)
    else:
        if node.left is None or node.right is None:
            child = node.left or node.right
            # å­èŠ‚ç‚¹æ•°é‡ = 0 ï¼Œç›´æ¥åˆ é™¤ node å¹¶è¿”å›
            if child is None:
                return None
            # å­èŠ‚ç‚¹æ•°é‡ = 1 ï¼Œç›´æ¥åˆ é™¤ node
            else:
                node = child
        else:
            # å­èŠ‚ç‚¹æ•°é‡ = 2 ï¼Œåˆ™å°†ä¸­åºéå†çš„ä¸‹ä¸ªèŠ‚ç‚¹åˆ é™¤ï¼Œå¹¶ç”¨è¯¥èŠ‚ç‚¹æ›¿æ¢å½“å‰èŠ‚ç‚¹
            temp = node.right
            while temp.left is not None:
                temp = temp.left
            node.right = self.remove_helper(node.right, temp.val)
            node.val = temp.val
    # æ›´æ–°èŠ‚ç‚¹é«˜åº¦
    self.update_height(node)
    # 2. æ‰§è¡Œæ—‹è½¬æ“ä½œï¼Œä½¿è¯¥å­æ ‘é‡æ–°æ¢å¤å¹³è¡¡
    return self.rotate(node)
```

### 3. æŸ¥æ‰¾èŠ‚ç‚¹
AVL æ ‘çš„èŠ‚ç‚¹æŸ¥æ‰¾æ“ä½œä¸äºŒå‰æœç´¢æ ‘ä¸€è‡´ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚

## 7.5.4 AVL æ ‘å…¸å‹åº”ç”¨
- ç»„ç»‡å’Œå­˜å‚¨å¤§å‹æ•°æ®ï¼Œé€‚ç”¨äºé«˜é¢‘æŸ¥æ‰¾ã€ä½é¢‘å¢åˆ çš„åœºæ™¯ã€‚
- ç”¨äºæ„å»ºæ•°æ®åº“ä¸­çš„ç´¢å¼•ç³»ç»Ÿã€‚
- çº¢é»‘æ ‘ä¹Ÿæ˜¯ä¸€ç§å¸¸è§çš„å¹³è¡¡äºŒå‰æœç´¢æ ‘ã€‚ç›¸è¾ƒäº AVL æ ‘ï¼Œçº¢é»‘æ ‘çš„å¹³è¡¡æ¡ä»¶æ›´å®½æ¾ï¼Œæ’å…¥ä¸åˆ é™¤èŠ‚ç‚¹æ‰€éœ€çš„æ—‹è½¬æ“ä½œæ›´å°‘ï¼ŒèŠ‚ç‚¹å¢åˆ æ“ä½œçš„å¹³å‡æ•ˆç‡æ›´é«˜ã€‚