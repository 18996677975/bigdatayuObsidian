# HDFS 删除保障
一句话概括为：为化解部分 HDFS 文件删除途径绕过默认回收站机制所引发的不安全隐患，针对 HDFS 构建全新删除操作策略，有力保障误删重要数据能够恢复。
在功能上线后，成功处理 2 次业务误操作导致的大库删除问题、10 余次表数据丢失问题以及 100 余次数据湖引入初期的合并文件丢失问题。该工具得到了组内外的一致好评。

简单介绍一下背景：
平台提供前端可视化HDFS操作页面中的删除调用FileSystem.delete()接口、hive指定Location覆盖HDFS已存在路径等方式，均会跳过 HDFS 自带回收站，导致 HDFS 数据可恢复性不佳，存在误操作导致的数据不可恢复风险。

主要的工作内容是：
首先，在 HDFS NameNode 原代码层面进行修改，针对 NameNodeRpcServer 类的 delete 方法进行逻辑调整，最终达到除临时数据、计算中间数据的删除强制进入中央回收站，独立中央回收站回收时间；
其次，构建中央回收站可视化管理页面，提供一键恢复功能；
最后，为解决因单次删除文件过多而引发的 NameNode 持锁时间过长的卡顿问题，进行了checkpoint 时间调整。

# OneSQL 语法转换
一句话概括为：本项目重点打造了基于 Antlr4 的 SQL 语法转换工具，能够支持 HiveSQL、SparkSQL、TrinoSQL 语法的自由转换，切实降低了因语法差异所导致的引擎使用门槛。
成功化解了业界类似开源产品中存在的嵌套子查询、嵌套函数调用转换异常以及单引号/双引号/反引号转换异常等问题。总计完成 102 个差异语法的转换，SQL 覆盖率达 99.13%。服务人数达 110 人，日均转换次数超 40 次，日均节省 10 小时/人。

背景：鉴于多种计算引擎均有其独特优势，存在需切换引擎进行查询的需求，然而语法差异致使切换过程艰难且耗费时间长，故而开发了一款一站式语法转换工具。

主要工作内容： 
以 TrinoSQL 中的 ANSI SQL 语法规则为基础，展开二次抽象与剪枝，构建更为通用的 SQL 基础语法抽象树；  
借助 Antlr4 构建各种引擎统一的抽象语法转换树，涵盖各种引擎中不一致的语法规则定义；
重新构建 SqlFormatter 类，实现自定义抽象语法转换树各种语法规则的 visitor，依照目标语法进行转换。

# HDFS 全平台升级
一句话概括为：通过采用两段式升级方式，即 2.7.2 -> 2.9.2 -> 3.3.2，成功达成 HDFS 不停机升级。

背景：鉴于 2.7.2 版本的 HDFS 性能存在不足，同时为了能够使用 EC、RBF 等新功能，故而进行 HDFS 升级操作。

主要工作内容： 
HDFS-14313 导致 2.7 版本的 HDFS 在升级至 2.8+版本时，DN 底层数据存储目录发生变动；HDFS-13596、HDFS-14509 等漏洞使得 NameNode 从 2.x 版本升级至 3.x 版本存在风险。经过多轮的测试与调研，最终决定选取两段式升级方式。  

成功解决了 DataNode 从 2.7.2 滚动升级至 2.9.2 时，DataNode 底层数据目录更新 `blockmove` 方法中部分线程出现异常，而 DataNode 未作相应处理，进而导致的 `block` 丢失问题。

# 机器搬迁
集团积极响应国家“东数西算”政策，为降低机房开销，要求将所有机器搬迁至贵州，此项目为 2023 下半年度 S 级项目。该项目由运维牵头，各业务线协同配合进行迁移，我在其中担任平台组的交接负责人。

项目成果：在集团内其他大数据团队方案及阿里云方案的对比中，我们做到了兼顾完整数据与最低硬件成本。而且在搬迁期间，对平台服务进行了全面梳理，实施了浪费资源缩容、无用服务下线等操作，最终下线 26 台老旧过保机器，有效降低了机房运维成本。

主要工作内容：
分为两部分：
管理方面：
进行合理的时间规划和任务划分，运用 Excel 表单进行项目管理，使项目人员明确各自的任务与时限，领导也能通过表单清晰掌握项目进展与风险。积极配合并协调运维方、平台业务方的服务依赖问题以及时间冲突问题。

实际搬迁事项：
1）负责 KDC、LDAP 等底层基础服务的迁移工作；  
2）制定并实施 HDFS 搬迁方案，按照搬迁顺序划分为逻辑三机架，并购置阿里云临时资源以补充 2 机架存储与计算。首批顺利完成两机架物理机的搬迁，在物理机搬迁的两周（机器恢复访问）期间，线上服务保持正常运行；  
3）开发“新数据同步功能”，针对物理机搬迁期间产生的新数据，在独立于 HDFS 逻辑的情况下，从物理层面将新 `block` 传输至贵州新服务器。该代码需具备如下功能：过滤中间/临时数据、优先选取非阿里云节点、进行单副本增量数据传输、将贵州单副本自动扩容为三副本以及开展全链路检查以确保 `block` 的完整性。

完整机器搬迁方案：
1）中台服务聚合；
2）重要服务域名化；
3）HDFS 机架划分，数据上云，计算上云；
4）机器搬迁；
5）底层服务迁移；
6）HDFS 存储恢复；
7）计算恢复；
8）中台服务、周边小服务恢复。